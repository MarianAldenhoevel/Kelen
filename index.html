<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
		<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kēlen Writing System</title>
	<script src="./jquery-3.6.0.min.js"></script>
	<script src="./d3.min.js"></script>	
	<link rel="stylesheet" href="style.css">      
</head>
<body>
	<h1>The Kēlen Writing System</h1>
	
	<h2>What is this?</h2>
	<p>Kēlen is a constructed alien language created by Sylvia Sotomayor. Among some other interesting linguistic concepts Kēlen also uses three
		different writing sytems: A regular script, a box script and a "ceremonial interlace alphabet".</p>
	<p>I was intruiged by these writing systems and especially the interlace alphabet. This page attempts to automatically translate
		romanized Kēlen into these writing systems.</p>
	</p>
	<p>You can find out all about Kēlen at <a href="https://www.terjemar.net/kelen/kelen.php">https://www.terjemar.net/kelen/kelen.php</a>. 
		Please refer to those pages for any information on the language, its creator or the back story. On this page below the interactive 
		part you can only find a short excerpt about the alphabet, the elements there are clickable so you can easily input your Kēlen string 
		regardless of what keyboard layout you are using.</p>
	</p>
	<h2>Kēlen Writer</h2>
	<div>
		<input id="edRomanization" type="text" placeholder="selnirre anlāsa sū-lānōraen;" style="width: 80%"></input>
	</div>
	<div>
		<canvas id="KelenScript"></canvas>		
	</div>	
	<div>
		<svg id="KelenCeremonial" style="display: none; border: 1px solid rgb(200,200,200);"></svg>
	</div>
	<div>
		<p class="indent" id="KelenScriptErrors"></p>
	</div>	
	<div>	
	</div>

	<h2>The Kelen Alphabet.</h2>
	<h3>Consonants</h3>
	<p>Traditionally, Kēlen claims five stops (<span class="kelen" data-kelen>ansāorīki anpōhi</span>). They are written thus:</p>
	<table>
		<tbody>
			<tr data-kelen="p"><td><span class="kelen">p</span> (<span class="kelen" data-kelen>japōha japiēxa</span>)</td><td><img src="font/p.gif" alt="p"> or <img src="font/p2.gif" alt="p"></td></tr>
			<tr data-kelen="t"><td><span class="kelen">t</span> (<span class="kelen" data-kelen>japōha japīra</span>)</td><td><img src="font/t.gif" alt="t"></td></tr>
			<tr data-kelen="s"><td><span class="kelen">s</span> (<span class="kelen" data-kelen>japōha jaxīwa</span>)</td><td><img src="font/s.gif" alt="s"></td></tr>
			<tr data-kelen="c"><td><span class="kelen">c</span> (<span class="kelen" data-kelen>japōha jūsne</span>)</td><td><img src="font/c.gif" alt="c"> or <img src="font/c2.gif" alt="c"></td></tr>
			<tr data-kelen="k"><td><span class="kelen">k</span> (<span class="kelen" data-kelen>japōha jakōλa</span>)</td><td><img src="font/k.gif" alt="k"> or <img src="font/k2.gif" alt="k"></td></tr>
		</tbody>
	</table>

	<p>There are the five fricatives (<span class="kelen" data-kelen>ansāorīki ankōrji</span>) to complement the five stops:</p>
	<table>
		<tbody>
			<tr data-kelen="w"><td><span class="kelen">w</span> (<span class="kelen" data-kelen>jakōrja japiēxa</span>)</td><td><img src="font/w.gif" alt="w"> or <img src="font/w2.gif" alt="w"> or <img src="font/w3.gif" alt="w"></td></tr>
			<tr data-kelen="þ"><td><span class="kelen">þ</span> (<span class="kelen" data-kelen>jakōrja japīra</span>)</td><td><img src="font/th.gif" alt="th"></td></tr>
			<tr data-kelen="x"><td><span class="kelen">x</span> (<span class="kelen" data-kelen>jakōrja jaxīwa</span>)</td><td><img src="font/x.gif" alt="sh"></td></tr>
			<tr data-kelen="j"><td><span class="kelen">j</span> (<span class="kelen" data-kelen>jakōrja jūsne</span>)</td><td><img src="font/j.gif" alt="j"> or <img src="font/j2.gif" alt="j"> or <img src="font/j3.gif" alt="j"></td></tr>
			<tr data-kelen="h"><td><span class="kelen">h</span> (<span class="kelen" data-kelen>jakōrja jakōλa</span>)</td><td><img src="font/h.gif" alt="h"> or <img src="font/h2.gif" alt="h"> or <img src="font/h3.gif" alt="h"></td></tr>
		</tbody>
	</table>

	<p>Then the fourteen sonorants (<span class="kelen" data-kelen>ansāorīki antāni</span>):</p>
	<table>
		<tbody>
			<tr><td data-kelen="m"><span class="kelen">m</span> (<span class="kelen" data-kelen>jahīña japiēxa</span>)</td><td data-kelen="m"><img src="font/m.gif" alt="m"></td>
				<td data-kelen="m">and&nbsp;&nbsp;&nbsp; <span class="kelen">mm</span> (<span class="kelen" data-kelen>jahīña japiēxa jōma</span>)</td><td data-kelen="mm"><img src="font/mm.gif" alt="mm"></td></tr>
			<tr><td data-kelen="n"><span class="kelen">n</span> (<span class="kelen" data-kelen>jahīña japīra</span>)</td><td data-kelen="n"><img src="font/n.gif" alt="n"></td>
				<td data-kelen="nn">and&nbsp;&nbsp;&nbsp; <span class="kelen">nn</span> (<span class="kelen" data-kelen>jahīña japīra jōma</span>)</td><td data-kelen="nn"><img src="font/nn.gif" alt="nn"></td></tr>
			<tr><td data-kelen="ñ"><span class="kelen">ñ</span> (<span class="kelen" data-kelen>jahīña jūsne</span>)</td><td data-kelen="ñ"><img src="font/nj.gif" alt="ñ"></td>
				<td data-kelen="ññ">and&nbsp;&nbsp;&nbsp; <span class="kelen">ññ</span> (<span class="kelen" data-kelen>jahīña jūsne jōma</span>)</td><td data-kelen="ññ"><img src="font/nnj.gif" alt="ññ"></td></tr>
			<tr><td data-kelen="ŋ"><span class="kelen">ŋ</span> (<span class="kelen" data-kelen>jahīña jakōλa</span>)</td><td data-kelen="ŋ"><img src="font/ng.gif" alt="ŋ"></td>
				<td data-kelen="ŋŋ">and&nbsp;&nbsp;&nbsp; <span class="kelen">ŋŋ</span> (<span class="kelen" data-kelen>jahīña jakōλa jōma</span>)</td><td data-kelen="ŋŋ"><img src="font/nng.gif" alt="ŋŋ"></td></tr>
			<tr><td>&nbsp;</td></tr>
			<tr><td data-kelen="l"><span class="kelen">l</span> (<span class="kelen" data-kelen>jatāna</span>)</td><td data-kelen="l"><img src="font/l.gif" alt="l"></td>
				<td data-kelen="ll">and&nbsp;&nbsp;&nbsp; <span class="kelen">ll</span> (<span class="kelen" data-kelen>jatāna jōma</span>)</td><td data-kelen="ll"><img src="font/ll.gif" alt="ll"></td>
				<td data-kelen="λ">and&nbsp;&nbsp;&nbsp; <span class="kelen">λ</span> (<span class="kelen" data-kelen>jatāna jūsne</span>)</td><td data-kelen="λ"><img src="font/lj.gif" alt="λ"></td></tr>
			<tr><td data-kelen="r"><span class="kelen">r</span> (<span class="kelen" data-kelen>jatāna jarūsa</span>)</td><td data-kelen="r"><img src="font/r.gif" alt="r"></td>
				<td data-kelen="rr">and&nbsp;&nbsp;&nbsp; <span class="kelen">rr</span> (<span class="kelen" data-kelen>jatāna jarūsa jōma</span>)</td><td data-kelen="lr"><img src="font/rr.gif" alt="rr"></td>
				<td data-kelen="rj">and&nbsp;&nbsp;&nbsp; <span class="kelen">rj</span> (<span class="kelen" data-kelen>jatāna jarūsa jūsne</span>)</td><td data-kelen="rj"><img src="font/rj.gif" alt="rj"></td></tr>
		</tbody>
	</table>

	<h3>Vowels</h3>
	<p>The vowels come in short and long:</p>
	<table>
		<tbody>
			<tr><td data-kelen="i"><span class="kelen">i</span></td><td data-kelen="i"><img src="font/i.gif" alt="i"></td><td data-kelen="ī">and&nbsp;&nbsp;&nbsp; <span class="kelen">ī</span></td><td data-kelen="ī"><img src="font/ii.gif" alt="ī"></td></tr>
			<tr><td data-kelen="e"><span class="kelen">e</span></td><td data-kelen="e"><img src="font/e.gif" alt="e"></td><td data-kelen="ē">and&nbsp;&nbsp;&nbsp; <span class="kelen">ē</span></td><td data-kelen="ē"><img src="font/ee.gif" alt="ē"></td></tr>
			<tr><td data-kelen="a"><span class="kelen">a</span></td><td data-kelen="a"><img src="font/a.gif" alt="a"></td><td data-kelen="ā">and&nbsp;&nbsp;&nbsp; <span class="kelen">ā</span></td><td data-kelen="ā"><img src="font/aa.gif" alt="ā"></td></tr>
			<tr><td data-kelen="o"><span class="kelen">o</span></td><td data-kelen="o"><img src="font/o.gif" alt="o"></td><td data-kelen="ō">and&nbsp;&nbsp;&nbsp; <span class="kelen">ō</span></td><td data-kelen="ō"><img src="font/oo.gif" alt="ō"></td></tr>
			<tr><td data-kelen="u"><span class="kelen">u</span></td><td data-kelen="u"><img src="font/u.gif" alt="u"></td><td data-kelen="ū">and&nbsp;&nbsp;&nbsp; <span class="kelen">ū</span></td><td data-kelen="ū"><img src="font/uu.gif" alt="ū"></td></tr>
		</tbody>
	</table>

	<p>The diphtongs also come in short and long:</p>
	<table>
		<tbody>
			<tr><td data-kelen="ae"><span class="kelen">ae</span></td><td data-kelen="ae"><img src="font/ae.gif" alt="ae"></td><td data-kelen="āe">and&nbsp;&nbsp;&nbsp; <span class="kelen">āe</span></td><td data-kelen="āe"><img src="font/aae.gif" alt="āe"></td></tr>
			<tr><td data-kelen="ao"><span class="kelen">ao</span></td><td data-kelen="ao"><img src="font/ao.gif" alt="ao"></td><td data-kelen="āo">and&nbsp;&nbsp;&nbsp; <span class="kelen">āo</span></td><td data-kelen="āo"><img src="font/aao.gif" alt="āo"></td></tr>
			<tr><td data-kelen="ie"><span class="kelen">ie</span></td><td data-kelen="ie"><img src="font/ie.gif" alt="ie"></td><td data-kelen="iē">and&nbsp;&nbsp;&nbsp; <span class="kelen">iē</span></td><td data-kelen="iē"><img src="font/iee.gif" alt="iē"></td></tr>
		</tbody>
	</table>
	<p data-kelen="y">The vowel <span class="kelen">y</span>, which occurs in Eastern Kēlen, is usually written the same way as <span class="kelen">i</span> <img src="font/i.gif" alt="i">.</p>

	<p>Punctuation consists of a 
	<span data-kelen=" "><img src="font/space.gif" alt="&nbsp;">
	to mark spaces between words (this is optional)</span>,<br>
	<span data-kelen=";"></span>and a <img src="font/end.gif" alt=";"> (<span class="kelen">;</span>) to mark the end of clauses or sentences.</span>
	</p>
	<h3>An example</h3>
	<p>
	<img src="font/s.gif" alt="s"><img src="font/e.gif" alt="e"><img src="font/l.gif" alt="l"><img src="font/n.gif" alt="n"><img src="font/i.gif" alt="i"><img src="font/rr.gif" alt="rr"><img src="font/space.gif" alt="&nbsp;"><img src="font/a.gif" alt="a"><img src="font/n.gif" alt="n"><img src="font/l.gif" alt="l"><img src="font/aa.gif" alt="ā"><img src="font/s.gif" alt="s"><img src="font/a.gif" alt="a"><img src="font/space.gif" alt="&nbsp;"><img src="font/s.gif" alt="s"><img src="font/uu.gif" alt="ū"><img src="font/l.gif" alt="l"><img src="font/aa.gif" alt="ā"><img src="font/n.gif" alt="n"><img src="font/oo.gif" alt="ō"><img src="font/r.gif" alt="r"><img src="font/ae.gif" alt="ae"><img src="font/n.gif" alt="n"><img src="font/end.gif" alt=";">&nbsp;&nbsp;&nbsp;is the equivalent of <br>
	<span class="kelen" data-kelen>selnirre anlāsa sū-lānōraen;</span> "We (1p-paucal) give you (2p-plural) welcome at(to) Lānōraen."
	</p>
	<h3>Alphabetical Order</h3>
	<p>Kēlen alphabetical order was finalized before the writing system 
	existed in its current form. Not all of the letters above are included. 
	Those that aren't officially included are unofficially included with 
	other letters. For example, the alphabetical order does not distinguish 
	between <img src="font/a.gif" alt="a"> and  <img src="font/aa.gif" alt="ā">, putting them both under <img src="font/a.gif" alt="a">. I have put extra letters in brackets next to the letters they are listed with.</p>

	<p>
	<img src="font/a.gif" alt="a"> {<img src="font/aa.gif" alt="ā">  <img src="font/ae.gif" alt="ae">  <img src="font/aae.gif" alt="āe">  <img src="font/ao.gif" alt="ao">  <img src="font/aao.gif" alt="āo">} 
	<img src="font/e.gif" alt="e"> {<img src="font/ee.gif" alt="ē">} 
	<img src="font/o.gif" alt="o"> {<img src="font/oo.gif" alt="ō">} 
	<img src="font/i.gif" alt="i"> {<img src="font/ii.gif" alt="ī">} 
	<img src="font/ie.gif" alt="ie"> {<img src="font/iee.gif" alt="iē">} 
	<img src="font/u.gif" alt="u"> {<img src="font/uu.gif" alt="ū">} 
	<img src="font/l.gif" alt="l"> {<img src="font/ll.gif" alt="ll">  <img src="font/lj.gif" alt="lj">} 
	<img src="font/nj.gif" alt="ñ"> {<img src="font/nnj.gif" alt="ññ">} 
	<img src="font/t.gif" alt="t"> 
	<img src="font/n.gif" alt="n"> {<img src="font/nn.gif" alt="nn">} 
	<img src="font/k.gif" alt="k"> {<img src="font/k2.gif" alt="k">} 
	<img src="font/th.gif" alt="th"> 
	<img src="font/m.gif" alt="m"> {<img src="font/mm.gif" alt="mm">  <img src="font/ng.gif" alt="ŋ">  <img src="font/nng.gif" alt="ŋŋ">} 
	<img src="font/c.gif" alt="c"> {<img src="font/c2.gif" alt="c">} 
	<img src="font/s.gif" alt="s"> 
	<img src="font/p.gif" alt="p"> {<img src="font/p2.gif" alt="p">} 
	<img src="font/w.gif" alt="w"> {<img src="font/w2.gif" alt="w">  <img src="font/w3.gif" alt="w">} 
	<img src="font/j.gif" alt="j"> {<img src="font/j2.gif" alt="j">  <img src="font/j3.gif" alt="j">} 
	<img src="font/r.gif" alt="r"> {<img src="font/rr.gif" alt="rr">  <img src="font/rj.gif" alt="rj">} 
	<img src="font/x.gif" alt="sh"> 
	<img src="font/h.gif" alt="h"> {<img src="font/h2.gif" alt="h">  <img src="font/h3.gif" alt="h">}
	</p>

	<p>Children have been known to recite the following rhyme:</p>

	<p>
	<span class="kelen">ā</span>, <span class="kelen">ē</span>, <span class="kelen">ō</span>,<br>
	<span class="kelen">ī</span>, <span class="kelen">iē</span>, <span class="kelen">ū</span>,<br>
	<span class="kelen">lā</span>, <span class="kelen">ñē</span>, <span class="kelen">tō</span>,<br>
	<span class="kelen">nā</span>, <span class="kelen">kā</span>, <span class="kelen">þō</span>,<br>
	<span class="kelen">mū</span>, <span class="kelen">cē</span>, <span class="kelen">sū</span>,<br>
	<span class="kelen">pāo</span>, <span class="kelen">wē</span>, <span class="kelen">jē</span>,<br>
	<span class="kelen">rā</span>, <span class="kelen">xō</span>, <span class="kelen">hē</span>.
	</p>

	<p>The romanization, being for us humans, has a different alphabetical 
	order than the native Kēlen script. The romanization is alphabetized 
	like so:</p>
	<p><span class="kelen">a</span>, <span class="kelen">ā</span>, <span class="kelen">ae</span>, <span class="kelen">āe</span>, <span class="kelen">ao</span>, <span class="kelen">āo</span>, <span class="kelen">c</span>, <span class="kelen">e</span>, <span class="kelen">ē</span>, <span class="kelen">h</span>, <span class="kelen">i</span>, <span class="kelen">ī</span>, <span class="kelen">ie</span>, <span class="kelen">iē</span>, <span class="kelen">j</span>, <span class="kelen">k</span>, <span class="kelen">l</span>, <span class="kelen">ll</span>, <span class="kelen">λ</span>, <span class="kelen">m</span>, <span class="kelen">mm</span>, <span class="kelen">n</span>, <span class="kelen">nn</span>, <span class="kelen">ñ</span>, <span class="kelen">ññ</span>, <span class="kelen">ŋ</span>, <span class="kelen">ŋŋ</span>, <span class="kelen">o</span>, <span class="kelen">ō</span>, <span class="kelen">p</span>, <span class="kelen">r</span>, <span class="kelen">rr</span>, <span class="kelen">rj</span>, <span class="kelen">s</span>, <span class="kelen">t</span>, <span class="kelen">þ</span>, <span class="kelen">u</span>, <span class="kelen">ū</span>, <span class="kelen">w</span>, <span class="kelen">x</span></p>

	<h2>Ceremonial interlace alphabet</h2>
	<a href="https://commons.wikimedia.org/wiki/K%C4%93len">https://commons.wikimedia.org/wiki/Kēlen</a>
	<table class="cia">
		<tbody>
			<tr>
				<td data-kelen="a"> 
					<span class="kelen">a</span>&nbsp;
					<img src="font/a.gif" alt="a">&nbsp;
					<svg class="kelen cia" id="ceremonial-a"></svg>
				</td>
				<td data-kelen="ñ"> 
					<span class="kelen">ñ</span>&nbsp;
					<img src="font/nj.gif" alt="ñ">&nbsp;
					<svg class="cia" id="ceremonial-nj"></svg>
				</td>
				<td data-kelen="e"> 
					<span class="kelen">e</span>&nbsp;
					<img src="font/e.gif" alt="e">&nbsp;
					<svg class="cia" id="ceremonial-e"></svg>
				</td>
				<td data-kelen="l"> 
					<span class="kelen">l</span>&nbsp;
					<img src="font/l.gif" alt="l">&nbsp;
					<svg class="cia" id="ceremonial-l"></svg>
				</td>
				<td data-kelen="o"> 
					<span class="kelen">o</span>&nbsp;
					<img src="font/o.gif" alt="o">&nbsp;
					<svg class="cia" id="ceremonial-o"></svg>
				</td>
				<td data-kelen="i"> 
					<span class="kelen">i</span>&nbsp;
					<img src="font/i.gif" alt="i">&nbsp;
					<svg class="cia" id="ceremonial-i"></svg>
				</td>
				<td data-kelen="ie"> 
					<span class="kelen">ie</span>&nbsp;
					<img src="font/ie.gif" alt="ie">&nbsp;
					<svg class="cia" id="ceremonial-ie"></svg>
				</td>
			</tr>

			<tr>
				<td data-kelen="k"> 
					<span class="kelen">k</span>&nbsp;
					<img src="font/k.gif" alt="k">&nbsp;
					<svg class="kelen cia" id="ceremonial-k"></svg>
				</td>
				<td data-kelen="u"> 
					<span class="kelen">u</span>&nbsp;
					<img src="font/u.gif" alt="u">&nbsp;
					<svg class="kelen cia" id="ceremonial-u"></svg>
				</td>
				<td data-kelen="n"> 
					<span class="kelen">n</span>&nbsp;
					<img src="font/n.gif" alt="n">&nbsp;
					<svg class="kelen cia" id="ceremonial-n"></svg>
				</td>
				<td data-kelen="t"> 
					<span class="kelen">t</span>&nbsp;
					<img src="font/t.gif" alt="t">&nbsp;
					<svg class="kelen cia" id="ceremonial-t"></svg>
				</td>
				<td data-kelen="th"> 
					<span class="kelen">th</span>&nbsp;
					<img src="font/th.gif" alt="th">&nbsp;
					<svg class="kelen cia" id="ceremonial-th"></svg>
				</td>
				<td data-kelen=m"> 
					<span class="kelen">m</span>&nbsp;
					<img src="font/m.gif" alt="m">&nbsp;
					<svg class="kelen cia" id="ceremonial-m"></svg>
				</td>
				<td data-kelen="p"> 
					<span class="kelen">p</span>&nbsp;
					<img src="font/p.gif" alt="p">&nbsp;
					<svg class="kelen cia" id="ceremonial-p"></svg>
				</td>
			</tr>

			<tr>
				<td data-kelen="w"> 
					<span class="kelen">w</span>&nbsp;
					<img src="font/w.gif" alt="w">&nbsp;
					<svg class="kelen cia" id="ceremonial-w"></svg>
				</td>
				<td data-kelen="s"> 
					<span class="kelen">s</span>&nbsp;
					<img src="font/s.gif" alt="s">&nbsp;
					<svg class="kelen cia" id="ceremonial-s"></svg>
				</td>
				<td data-kelen="c"> 
					<span class="kelen">c</span>&nbsp;
					<img src="font/c.gif" alt="c">&nbsp;
					<svg class="kelen cia" id="ceremonial-c"></svg>
				</td>
				<td data-kelen="j"> 
					<span class="kelen">j</span>&nbsp;
					<img src="font/j.gif" alt="j">&nbsp;
					<svg class="kelen cia" id="ceremonial-j"></svg>
				</td>
				<td data-kelen="x"> 
					<span class="kelen">x</span>&nbsp;
					<img src="font/x.gif" alt="x">&nbsp;
					<svg class="kelen cia" id="ceremonial-x"></svg>
				</td>
				<td data-kelen="h"> 
					<span class="kelen">h</span>&nbsp;
					<img src="font/h.gif" alt="h">&nbsp;
					<svg class="kelen cia" id="ceremonial-h"></svg>
				</td>
				<td data-kelen="r"> 
					<span class="kelen">r</span>&nbsp;
					<img src="font/r.gif" alt="r">&nbsp;
					<svg class="kelen cia" id="ceremonial-r"></svg>
				</td>
			</tr>
		</tbody>
	</table>

	<div id='allGlyphs'></div>
</body>

<script>

	// Base class modelling a ceremonial interlace letter.
	class CIA {

		// point to the svg where you want the letter rendered. height and width
		// of the bounding box in cells and the coordinates of the starting cell.
		constructor(svg, kheight, kwidth) {
			this.svg = svg;
			this.kheight = kheight;
			this.kwidth = kwidth;
			this.fill = CIA.fill;
			this.incell = null;
			this.outcell = null;
			
			// Build an array of tiles. Each holds the z-depth, type of tile 
			// and fill color.
			this.ktile = new Array(this.kwidth);
			for(var x = 0; x < this.kheight; x++) {
				this.ktile[x] = (new Array(this.kheight)).fill([-1, '', '']);
			}

			// Resize the SVG element.
			this.svg.attr('width', this.kwidth * CIA.cia_unit + CIA.stroke_width).attr('height', this.kheight * CIA.cia_unit + CIA.stroke_width);		
		}
		
		goto(kx, ky, fill) {
			this.kx = kx;
			this.ky = ky;
			if (fill) {
				this.fill = fill;
			}

			return this;
		}

		in() {
			this.incell = [this.kx, this.ky];
			return this;
		}

		out() {
			this.outcell = [this.kx, this.ky];
			return this;
		}

		// Return the screen-coordinates of the current cell based on current 
		// cell coordinates kx and ky.		
		cell() {
			return {
				left:   this.kx * CIA.cia_unit + CIA.stroke_width/2,
				bottom: (this.kheight-this.ky) * CIA.cia_unit + CIA.stroke_width/2, 
				right:  (this.kx+1) * CIA.cia_unit + CIA.stroke_width/2, 
				top:    (this.kheight-this.ky-1) * CIA.cia_unit + CIA.stroke_width/2
			};
		}

		// Place a tile at kx/ky at z-depth z. This checks the z-buffer and may
		// skip the tile if there is already on at greater z-height.
		checkz(z, tile) {
			if (!z) { z = 0 };
			var oldz = this.ktile[this.kx][this.ky][0];
			var log = tile + ' at (' + this.kx + ',' + this.ky + ') old-z=' + oldz + ' new-z=' + z;
			var result = false; 

			if (oldz < z) {
				log += ' -> render';
				this.ktile[this.kx][this.ky] = [z, tile, this.fill];
				result = true;
			} else {
				log += ' -> don\'t render';
			}

			// console.log(log);
			return result;
		}

		// Fill cell background with a rect-element.
		fillcell(fill) {
			var cell = this.cell();
			this.svg.append('rect')
				.attr('x', cell.left)
				.attr('y', cell.top)
				.attr('width', CIA.cia_unit)
				.attr('height', CIA.cia_unit)
				.attr('stroke', 'none')
				.attr('stroke-width', '0')
				.attr('fill', fill);
		}

		// Draw any combination of four cell borders.
		drawcellborders(left, top, right, bottom) {
			var cell = this.cell()
			
			if (left) {
				this.svg.append('line')
				.style("stroke", CIA.stroke)
				.style("stroke-width", CIA.stroke_width)
				.attr("x1", cell.left)
				.attr("y1", cell.top)
				.attr("x2", cell.left)
				.attr("y2", cell.bottom);
			}

			if (top) {
				this.svg.append('line')
				.style("stroke", CIA.stroke)
				.style("stroke-width", CIA.stroke_width)
				.attr("x1", cell.left)
				.attr("y1", cell.top)
				.attr("x2", cell.right)
				.attr("y2", cell.top);
			}

			if (right) {
				this.svg.append('line')
				.style("stroke", CIA.stroke)
				.style("stroke-width", CIA.stroke_width)
				.attr("x1", cell.right)
				.attr("y1", cell.top)
				.attr("x2", cell.right)
				.attr("y2", cell.bottom);
			}

			if (bottom) {
				this.svg.append('line')
				.style("stroke", CIA.stroke)
				.style("stroke-width", CIA.stroke_width)
				.attr("x1", cell.left)
				.attr("y1", cell.bottom)
				.attr("x2", cell.right)
				.attr("y2", cell.bottom);
			}
		}

		// Render the whole letter by iterating over the tiles.
		render() {
			// console.log('render');

			for(this.kx = 0; this.kx < this.kwidth; this.kx++) {
				for(this.ky = 0; this.ky < this.kheight; this.ky++) {
					var tile = this.ktile[this.kx][this.ky];
					if (tile[1]) {
						this.fillcell(tile[2]);
					}
				}
			}

			for(this.kx = 0; this.kx < this.kwidth; this.kx++) {
				for(this.ky = 0; this.ky < this.kheight; this.ky++) {
					var tile = this.ktile[this.kx][this.ky];
					// console.log('(' + this.kx + ',' + this.ky + ') ' +  tile);

														          // left,  top,   right, bottom
					if (tile[1] == 'north')     this.drawcellborders(true,  false, true,  false);
					if (tile[1] == 'east')      this.drawcellborders(false, true,  false, true );
					if (tile[1] == 'west')      this.drawcellborders(false, true,  false, true );
					if (tile[1] == 'south')     this.drawcellborders(true,  false, true,  false);
					if (tile[1] == 'northwest') this.drawcellborders(false, true,  true,  false);
					if (tile[1] == 'westnorth') this.drawcellborders(true,  false, false, true );
					if (tile[1] == 'westsouth') this.drawcellborders(true,  true,  false, false);
					if (tile[1] == 'northeast') this.drawcellborders(true,  true,  false, false); 
					if (tile[1] == 'eastnorth') this.drawcellborders(false, false, true,  true );
					if (tile[1] == 'eastsouth') this.drawcellborders(false, true,  true,  false);
					if (tile[1] == 'southeast') this.drawcellborders(true,  false, false, true );
					if (tile[1] == 'southwest') this.drawcellborders(false, false, true,  true );
				}
			}
		}

		// One method each for the directions and corners. Places a tile at the
		// current position, considering z-depth, and updates current position
		// based on the last direction.
		north(z) {				
			this.checkz(z, 'north');
			this.ky = this.ky+1;
			return this;
		}

		east(z) {
			this.checkz(z, 'east');
			this.kx = this.kx+1;
			return this;
		}

		west(z) {
			this.checkz(z, 'west');
			this.kx = this.kx-1;
			return this;
		}

		south(z) {
			this.checkz(z, 'south');
			this.ky = this.ky-1;
			return this;
		}
		
		northwest(z) {
			this.checkz(z, 'northwest');
			this.kx = this.kx-1;
			return this;
		}
		
		westnorth(z) {
			this.checkz(z, 'westnorth');
			this.ky = this.ky+1;
			return this;
		}
		
		westsouth(z) {
			this.checkz(z, 'westsouth');
			this.ky = this.ky-1;
			return this;
		}
		
		northeast(z) {
			this.checkz(z, 'northeast');
			this.kx = this.kx+1;
			return this;
		}

		eastnorth(z) {
			this.checkz(z, 'eastnorth');
			this.ky = this.ky+1;
			return this;
		}

		eastsouth(z) {
			this.checkz(z, 'eastsouth');
			this.ky = this.ky-1;
			return this;
		}

		southeast(z) {
			this.checkz(z, 'southeast');
			this.kx = this.kx+1;
			return this;
		}

		southwest(z) {
			this.checkz(z, 'southwest');
			this.kx = this.kx-1;
			return this;
		}
	}

	// Static constants.
	CIA.cia_unit = 20;
	CIA.stroke_width = 2;
	CIA.OVER = 1;
	CIA.UNDER = 0;

	CIA.fill = 'white';
	CIA.stroke = 'black';

	// One descendant of class CIA per ceremonial letter. Each adds a constructor that
	// builds the path.
	class CIA_a extends CIA {
		constructor(svg) {
			super(svg, 3, 3);

			this.goto(1,0)
				.in()
				.north()
				.north()
				.northwest()
				.westsouth()
				.southeast()
				.east(CIA.UNDER)
				.east()
				.out();
			
			this.render();
		}
	}
  
	class CIA_nj extends CIA {
		constructor(svg) {
			super(svg, 4, 4);

			this.goto(2,0)
				.in()
				.north()
				.north()
				.northwest()
				.west(CIA.UNDER)
				.westnorth()
				.northeast()
				.eastsouth()
				.south(CIA.OVER)
				.southeast()
				.east(CIA.UNDER)
				.east()
				.out()
				
			this.render();
		}
	}

	class CIA_e extends CIA {
		constructor(svg) {
			super(svg, 4, 4);

			this.goto(1,0)
				.in()
				.north()
				.north()
				.north(CIA.UNDER)
				.northeast()
				.eastsouth()
				.south()
				.southwest()
				.west(CIA.UNDER)
				.westnorth()
				.northeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east()
				.out();

			this.render();
		}
	}

	class CIA_l extends CIA {
		constructor(svg) {
			super(svg, 6, 6);

			this.goto(4,0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.westsouth()
				.south()			
				.southeast()
				.east(CIA.UNDER)
				.eastnorth()
				.northwest()
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.westsouth()
				.southeast()
				.east(CIA.OVER)
				.eastnorth()
				.north(CIA.UNDER)
				.northwest()
				.westsouth()
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.southeast()
				.eastnorth()
				.north(CIA.OVER)
				.northwest()
				.west(CIA.UNDER)
				.westsouth()
				.southeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east()
				.east(CIA.OVER)
				.east()
				.out()

				.goto(3,2, 'black')
				.east();

			this.render();
		}
	}

	class CIA_o extends CIA {
		constructor(svg) {
			super(svg, 5, 5, 3, 0);

			this.goto(3,0)
				.in()
				.north()
				.north(CIA.OVER)
				.northwest()
				.west(CIA.UNDER)
				.west()
				.westsouth()
				.southeast()
				.eastnorth()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northwest()
				.westsouth()
				.southeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.eastnorth()
				.northwest()
				.westsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southeast()
				.east(CIA.UNDER)
				.east()
				.out();

			this.render();
		}
	}
	
	class CIA_i extends CIA {
		constructor(svg) {
			super(svg, 6, 6);

			this.goto(3,0)
				.in()
				.north()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.westsouth()
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()
				.westnorth()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.eastsouth()
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.westsouth()
				.southeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.east()
				.out();

			this.render();
		}
	}
	
	class CIA_ie extends CIA {
		constructor(svg) {
			super(svg, 6, 6);

			this.goto(4,0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.westsouth()
				.south(CIA.OVER)
				.southeast()
				.east(CIA.UNDER)
				.eastnorth()
				.northwest()
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.west()
				.westsouth()
				.south()
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.southeast()
				.eastnorth()
				.north(CIA.OVER)
				.northwest()
				.west(CIA.UNDER)
				.westsouth()
				.southeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east()
				.east(CIA.OVER)
				.east()
				.out()

				.goto(2,3, 'black')
				.east()

				.goto(3,2, 'black')
				.east();

			this.render();
		}
	}
	
	class CIA_k extends CIA {
		constructor(svg) {
			super(svg, 7, 7);
			
			this.goto(4,0)
				.in()
				.north()
				.north()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east()
				.east()
				.out()

				.goto(3,1, 'green')
				.eastnorth()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northwest()
				.westsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southeast()

				.goto(0,3, 'yellow')
				.southeast(CIA.UNDER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.eastnorth()
				.northwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westsouth();

			this.render()
		}
	}
	
	class CIA_u extends CIA {
		constructor(svg) {
			super(svg, 5, 5);
			
			this.goto(1,0)
				.in()
				.north()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northwest()
				.westsouth()
				.southeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east()
				.out()

				.goto(0,1, 'green')
				.westnorth()
				.northeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.eastnorth()
				.north(CIA.OVER)
				.northwest()
				.westsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()
				.east(CIA.UNDER);

			this.render()
		}
	}

	class CIA_n extends CIA {
		constructor(svg) {
			super(svg, 6, 6);

			this.goto(3,0)
				.in()
				.north()
				.north()
				.north(CIA.UNDER)
				.north()
				.northwest()
				.west(CIA.UNDER)
				.westsouth()
				.south(CIA.OVER)
				.southeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.east()
				.out()

				.goto(1,1, 'green')
				.east()
				.eastnorth()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.east()
				.eastsouth()
				.south()
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.westsouth()
				.south()
				.southeast()
			
			this.render()
		}
	}
	
	class CIA_t extends CIA {
		constructor(svg) {
			super(svg, 5, 5);
			
			this.goto(2,0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.west()
				.westsouth()
				.south()
				.southeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.out()

				.goto(1,1, 'green')
				.southeast()
				.east(CIA.OVER)
				.eastnorth()
				.north(CIA.UNDER)
				.northwest()
				.west(CIA.OVER)
				.westsouth()
				.south(CIA.UNDER);

			this.render()
		}
	}

	class CIA_th extends CIA {
		constructor(svg) {
			super(svg, 7, 7);
			
			this.goto(3,0)
				.in()
				.north()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northwest()
				.west()
				.west()
				.westsouth()
				.south()
				.south()
				.southeast()
				.east(CIA.OVER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.OVER)
				.east()
				.out()

				.goto(2,1, 'green')
				.eastnorth()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northwest()
				.westsouth()
				.southeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.eastnorth()
				.northwest()
				.westsouth()
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southeast()
				.eastnorth()
				.northwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.westsouth()
				.southeast();

			this.render()
		}
	}
	
	class CIA_m extends CIA {
		constructor(svg) {
			super(svg, 7, 7);
			
			this.goto(3,0)
				.in()
				.north()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.west(CIA.OVER)
				.westsouth()
				.south(CIA.UNDER)
				.southeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.OVER)
				.east()
				.out()

				.goto(2,1, 'green')
				.southwest()
				.westnorth()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.eastsouth()
				.southwest()
				.westnorth()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.eastsouth()
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westnorth()
				.north()
				.northeast()
				.east()
				.eastsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER);
				
			this.render()
		}
	}

	class CIA_p extends CIA {
		constructor(svg) {
			super(svg, 7, 7);
			
			this.goto(2,0)
				.in()
				.north()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.east()
				.eastsouth()
				.south()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west()
				.westnorth()
				.north()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.east()
				.out()

				.goto(3,1, 'green')
				.westnorth()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northwest()
				.west(CIA.UNDER)
				.westsouth()
				.south(CIA.OVER)
				.southeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.eastsouth()
				.south()
				.southwest()
				.west();				

			this.render()
		}
	}
	
	class CIA_w extends CIA {
		constructor(svg) {
			super(svg, 6, 6);
			
			this.goto(2,0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.eastsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westnorth()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.out()

				.goto(1,1, 'green')
				.westnorth()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.westsouth()
				.southeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.eastsouth()
				.south(CIA.UNDER)
				.south()
				.southwest()
				.west()
				.west(CIA.UNDER);

			this.render()
		}
	}
	
	class CIA_s extends CIA {
		constructor(svg) {
			super(svg, 6, 6);
			
			this.goto(2,0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.eastsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westnorth()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.out()

				.goto(1,1, 'green')
				.westnorth()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.eastsouth()
				.south(CIA.UNDER)
				.south()
				.southwest()
				.west()
				.west(CIA.UNDER);

			this.render()
		}
	}
	
	class CIA_c extends CIA {
		constructor(svg) {
			super(svg, 6, 6);
			
			this.goto(2,0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.east()
				.eastsouth()
				.south()
				.south(CIA.UNDER)
				.south()
				.southwest()
				.west()
				.west(CIA.OVER)
				.west()
				.westnorth()
				.north()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()	

				.goto(1,2, 'green')
				.southeast()
				.east(CIA.UNDER)
				.eastnorth()
				.north(CIA.OVER)
				.northwest()
				.west(CIA.UNDER)
				.westsouth()
				.south(CIA.OVER);
			
			this.render()
		}
	}
	
	class CIA_j extends CIA {
		constructor(svg) {
			super(svg, 8, 8);
			
			this.goto(3,0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.OVER)
				.northeast()
				.east()
				.east()
				.eastsouth()
				.south()
				.south()
				.south(CIA.UNDER)
				.south()
				.south()
				.southwest()
				.west()
				.west()
				.west(CIA.OVER)
				.west()
				.west()
				.westnorth()
				.north()
				.north()
				.northeast()
				.east()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.OVER)
				.east()
				.out()

				.goto(1,2, 'green')
				.westnorth()
				.northeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.eastsouth()
				.southwest()
				.westnorth()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northeast()
				.eastsouth()
				.southwest()
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westnorth()
				.northeast()
				.eastsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.southwest();

			this.render()
		}
	}
	
	class CIA_x extends CIA {
		constructor(svg) {
			super(svg, 7, 7);

			this.goto(2,0)
				.in()
				.north()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.eastsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westnorth()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.east()
				.out()

				.goto(0,1, 'green')
				.southeast()
				.eastnorth()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.westsouth()
				.southeast()
				.east()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.eastnorth()
				.northwest()
				.westsouth()
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south()
				.south(CIA.OVER)
				.southeast()
				.eastnorth()
				.northwest()
				.west(CIA.UNDER)
				.west()
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.westsouth();
			
			this.render()
		}
	}
	
	class CIA_h extends CIA {
		constructor(svg) {
			super(svg, 7, 7);

			this.goto(4, 0)
				.in()
				.north()
				.north()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.eastsouth()
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.ABOVE)
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.westnorth()
				.northeast()
				.eastsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()
				.westnorth()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east()
				.east()
				.out()
	
				.goto(2, 1, 'green')
				.westnorth()
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.northeast()
				.eastsouth()
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.southwest()

				.goto(0, 3, 'yellow')
				.westnorth()
				.northeast()
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.eastsouth()
				.southwest()
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.west(CIA.OVER);

			this.render()
		}
	}
	
	class CIA_r extends CIA {
		constructor(svg) {
			super(svg, 7, 7);
			
			this.goto(5, 0)
				.in()
				.north()
				.north(CIA.UNDER)
				.north()
				.northwest()
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.west(CIA.OVER)
				.west(CIA.UNDER)
				.westsouth()
				.south()
				.southeast()
				.east()
				.eastnorth()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northwest()
				.west()
				.westsouth()
				.south()
				.southeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.eastnorth()
				.north()
				.northwest()
				.west()
				.westsouth()
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.southeast()
				.east()
				.east(CIA.OVER)
				.east()
				.out()

				.goto(1, 2, 'green')
				.westnorth()
				.north(CIA.OVER)
				.north(CIA.UNDER)
				.northeast()
				.east(CIA.OVER)
				.east(CIA.UNDER)
				.eastsouth()
				.south(CIA.OVER)
				.south(CIA.UNDER)
				.southwest()
				.west(CIA.OVER)
				.west(CIA.UNDER);

			this.render()
		}
	}

	var cia = {
		'a':  new CIA_a(d3.select("#ceremonial-a")),
		'nj': new CIA_nj(d3.select("#ceremonial-nj")),
		'e':  new CIA_e(d3.select("#ceremonial-e")),
		'l':  new CIA_l(d3.select("#ceremonial-l")),
		'o':  new CIA_o(d3.select("#ceremonial-o")),
		'i':  new CIA_i(d3.select("#ceremonial-i")),
		'ie': new CIA_ie(d3.select("#ceremonial-ie")),

		'k':  new CIA_k(d3.select("#ceremonial-k")),
		'u':  new CIA_u(d3.select("#ceremonial-u")),
		'n':  new CIA_n(d3.select("#ceremonial-n")),
		't':  new CIA_t(d3.select("#ceremonial-t")),
		'th': new CIA_th(d3.select("#ceremonial-th")),
		'm':  new CIA_m(d3.select("#ceremonial-m")),
		'p':  new CIA_p(d3.select("#ceremonial-p")),

		'w':  new CIA_w(d3.select("#ceremonial-w")),
		's':  new CIA_s(d3.select("#ceremonial-s")),
		'c':  new CIA_c(d3.select("#ceremonial-c")),
		'j':  new CIA_j(d3.select("#ceremonial-j")),
		'x':  new CIA_x(d3.select("#ceremonial-x")),
		'h':  new CIA_h(d3.select("#ceremonial-h")),
		'r':  new CIA_r(d3.select("#ceremonial-r"))
	};

	var edRomanizationCaretPos = 0;

	// Map a romanization to the filename of a Kēlen character. File-extension is added when used.
	var roman2font = new Map();
	roman2font.set('p', 'p');
	roman2font.set('t', 't');
	roman2font.set('s', 's');
	roman2font.set('c', 'c');
	roman2font.set('k', 'k');

	roman2font.set('w', 'w');
	roman2font.set('þ', 'th');
	roman2font.set('x', 'x');
	roman2font.set('j', 'j');
	roman2font.set('h', 'h');
		
	roman2font.set('m', 'm');
	roman2font.set('n', 'n');
	roman2font.set('ñ', 'nj');
	roman2font.set('ŋ', 'ng');

	roman2font.set('mm', 'mm');
	roman2font.set('nn', 'nn');
	roman2font.set('ññ', 'nnj');
	roman2font.set('ŋŋ', 'nng');
	
	roman2font.set('l',  'l'); 
	roman2font.set('ll', 'll');
	roman2font.set('λ',  'lj'); 
	roman2font.set('r',  'r'); 
	roman2font.set('rr', 'rr');
	roman2font.set('rj', 'rj');

	roman2font.set('i', 'i');
	roman2font.set('e', 'e');
	roman2font.set('a', 'a');
	roman2font.set('o', 'o');
	roman2font.set('u', 'u');
	
	roman2font.set('ī', 'ii');
	roman2font.set('ē', 'ee');
	roman2font.set('ā', 'aa');
	roman2font.set('ō', 'oo');
	roman2font.set('ū', 'uu');
	
	roman2font.set('ae', 'ae');
	roman2font.set('ao', 'ao');
	roman2font.set('ie', 'ie');

	roman2font.set('āe', 'aae');
	roman2font.set('āo', 'aao');
	roman2font.set('iē', 'iee');
	
	// Extra vowel
	roman2font.set('y', 'i');

	// Punctuation
	roman2font.set('_', 'space');
	roman2font.set(';', 'end');
	
	// Characters that are legal but not written.
	roman2font.set('-', 'skip');
	roman2font.set('\'', 'skip');

	function update_url() {
		// Create a linkeable URL to capture the current setup.	
		// console.log('update_url()');
		
		var url = window.location.protocol + '//' + window.location.host + window.location.pathname;
	
		url += '?r=' + $('#edRomanization').val();
		
		history.replaceState(null, '', url);
	}
	
	function parse_url() {
		// Parse the query-string to recreate a saved setup from an URL.
		// console.log('parse_url()');
		
		var vars = {}
		if (window.location.href.indexOf('?') != -1) { 
			var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
			for (var i = 0; i < hashes.length; i++)
			{
				var hash = hashes[i].split('=');
				vars[hash[0]] = decodeURI(hash[1]);
			}
		}

		if (vars['r']) {
			$('#edRomanization').val(vars['r']);
		}
	}
	
	function kelenClick(e) {
		// console.log('kelenClick()');
		
		e.stopPropagation();
		
		var input = '';

		// Find the nearest parent of the clicked element that has a data-kelen or
		// data-kelen attribute.
		var o = e.target;
		while(o) {
			if (o.hasAttribute('data-kelen')) {
				roman = o.getAttribute('data-kelen');
				if (roman) {
					input = '/' + roman + '/';
					break;
				}
				
				input = o.innerHTML;
				break;
			}  
			
			o = o.parentElement;
		}
		
		if (input) {
			// Got input. "Type" that romanized Kēlen into the input field.
			var oldval = $('#edRomanization').val();
			var newval = oldval.substring(0, edRomanizationCaretPos) + input + oldval.substring(edRomanizationCaretPos); 
			$('#edRomanization').val(newval);
			
			update_url();
			updateKelenScript();

			edRomanizationCaretPos = edRomanizationCaretPos + 2 + input.length;
		}

	}

	function updateKelenScript() {
		// Find all the glyphs that make up the input word in Kēlen and draw them
		// onto a canvas.  
	
		var roman = $('#edRomanization').val().toLowerCase().replace(/ /g, '_');
		console.log('updateKelenScript("' + roman + '")');

		$('#KelenScriptErrors').empty();
		var glyphs = [];
		var cialetters = [];
		var errors = [];

		while(roman) {
			// Figure out what character to render next.
			var char = '';

			// If there is a '/' at the start, find the next and extract that part. This
			// will absolutely be used then!
			if (roman.substring(0,1) == '/') {
				roman = roman.substring(1);
				var p = roman.indexOf('/');
				if (p == -1)
				{
					$('#KelenScriptErrors').append('<span>Closing / is missing</span><br>');
					roman = '';
				} else {
					char = roman.substring(0,p);
					roman = roman.substring(p+1);
				}
			} else {
				// Check for diphtong first.
				char = roman.substring(0,2);
			
				// Is this two-latin-letter-sequence a Kēlen-diphtong?
				if (!roman2font.has(char)) {
					// Not a diphtong, use single character.
					char = roman.substring(0,1);
				}

				// go on with the rest of the romanization.
				roman = roman.substring(char.length);
			}

			// Have we got a character? This can fail if the /*/-Notation is used wrongly.
			if (char) {
				// Is it a valid Kēlen character?
				if (roman2font.has(char)) {
					// Yes. Do we want a glyph for it or is it a skip?
					if (roman2font.get(char) == 'skip') {
						// No. Silently skip.
					} else {
						// Add an image to render.
						var fontchar = roman2font.get(char);
						glyphs.push($('#kelen-glyph-' + fontchar)[0]);
						cialetters.push(cia[fontchar]);
					}
		 		} else {
					// No. Skip this character. If we have not yet reported it as non-kelen add an error message.
					if (errors.indexOf(char) == -1) {
						errors.push(char);
						$('#KelenScriptErrors').append('<span><span class="kelen">' + char + '</span> is not Kēlen</span><br>');					
					}				
				}
			} else {
				// Something went wrong that does not warrant parsing the rest of
				// the input. Bail.
				break;
			}
		}

		// Now render all the glyphs to the script-canvas.
		var KelenScript = $('#KelenScript')[0];
   		var context = KelenScript.getContext("2d");
   		
		var w = 0;
		var h = 0;
		
		for (var glyph of glyphs) {
			w = w + glyph.width;
			h = Math.max(h, glyph.height);
		};

		KelenScript.width = w;
		KelenScript.height = h;

		var x = 0;
		for (var glyph of glyphs) {
			context.drawImage(glyph, x, 0),
			x = x + glyph.width;
		};

		// And then render all the ceremonial-svgs to the ceremonial-svg.
		// Get target-SVG as d3-selection:
		var KelenCeremonial = d3.select('#KelenCeremonial');
		KelenCeremonial.html('');
		var rotationgroup = KelenCeremonial.append('g');

		var kx = 0;
		var maxkx = 0;
		var ky = 0;
		var klineheight = 0;
		//var n = 0;
		for (var letter of cialetters) {
			var svg = letter.svg;
			rotationgroup
				.append('g')
					.attr('transform', 'translate(' + (CIA.cia_unit * kx) + ',' + (CIA.cia_unit * ky) + ')')
					.attr('class', letter.svg.node().id)
				.append('use')
					.attr('href', '#' + svg.node().id);
			
					kx = kx + letter.kwidth;
			klineheight = Math.max(klineheight, letter.kheight);
			
			/*
			n = n+1;
			// "linebreak"
			if (n%3 == 0) {
				ky = ky + klineheight;
				maxkx = Math.max(kx, maxkx);
				kx = 0;
				klineheight = 0;
			}
			*/
		}

		// "linebreak"
		if (klineheight) {
			ky = ky + klineheight;
			maxkx = Math.max(kx, maxkx);
			kx = 0;
			klineheight = 0;
		}

		// Resize SVG to fit.
		var w = maxkx * CIA.cia_unit + CIA.stroke_width;
		var h = ky * CIA.cia_unit + CIA.stroke_width;
		
		// rotationgroup.attr('transform', 'rotate(45 ' + (w/2) + ' ' + (h/2) + ')');
		
		KelenCeremonial.attr('width', w).attr('height', h);		
	}

	$(document).ready(function() {
		// Main entry point.
		console.log('document.ready()');
	
		// Overwrite initial UI settings with parameters from the URL if specified.
		parse_url();
			
		// Wire UI control events.
		edRomanizationCaretPos = $('#edRomanization').val().length;
		$('#edRomanization').on('blur', function(e) {
			edRomanizationCaretPos = $('#edRomanization')[0].selectionStart;				
		});

		$('#edRomanization').on('keyup', function(e) {
			update_url();
			updateKelenScript();
		});

		$('*[data-kelen]').click(kelenClick);
		
		// Preload all glyphs with proper ids.
		roman2font.forEach(function(value, key) {
			$('#allGlyphs').append('<img id="kelen-glyph-' + value + '" src="font/' + value + '.gif" alt="' + key + '" />');
		});

		// Fire after everything has loaded. Including our new images.
		$(window).on("load", function() {
    		console.log('window.load()');
			update_url();
			updateKelenScript();
		});

	});

</script>
	
</html>